---
title: "data_clinical_patient_analysis"
author: "Romane"
format: html
editor: visual
---

## Importing libraries

```{r}
#| echo : False
library("tidyverse")
library('here')
library('Cairo')
library('survival')
library('survminer')
```

## Importing data

```{r}
raw_patients <- read.csv(file = "../raw/tmb_mskcc_2018/data_clinical_patient.txt",sep = "\t", header = TRUE)
#open txt file as a csv, sepertation as tabs: "\t"
```

```{r}
#removing the 4 first rows that "explain" the columns
patients <- raw_patients[-c(1,2,3,4),]
```

## Data Wrangling

```{r}
#Chage names to shorter ones:
patients <- patients |> 
  rename(Survival_Months = Overall.Survival..Months., 
         OS_status = Overall.Survival.Status,
         Age_group = Age.Group.at.Diagnosis.in.Years,
         Patient_ID = X.Patient.Identifier)
```

```{r}
#Changing the OS status to numeric + adding a column to make it clearer (in case)
#0 for the Living patients
#1 for the patients that died
patients <- patients |> 
  mutate( 
    OS_status = case_when(OS_status == "0:LIVING" ~ 0,
                          OS_status == "1:DECEASED" ~ 1), 
    Sex_num = case_when(Sex == 'Male' ~ 0,
                    Sex == 'Female' ~ 1))
```

More data wrangling could be done?

```{r}
patients |> 
  mutate(Age_group = factor(
      Age_group,
      levels = c("<30", "31-50", "50-60", "61-70", ">71"),
      ordered = TRUE
    ),)
```

```{r}
patients <- patients |>
  mutate(
    Age_average = case_when(
      Age_group == "<30" ~ 25,
      Age_group == "31-50" ~ 40,
      Age_group == "50-60" ~ 55,
      Age_group == "61-70" ~ 65,
      Age_group == ">71" ~ 75
    )
  )
```

```{r}
patients <- patients |> 
  mutate(Survival_Months = as.numeric(Survival_Months),
         Age_average = as.numeric(Age_average)) 
```

```{r}
current_raw_data_path <- here('data')

patients |> 
  write_tsv(file = file.path(current_raw_data_path,'data_clinical_patients_clean.tsv'))


```

age group -\> make factors based on age group

"early"

## Plots

We will be looking at the proportion of men vs women that have survived the cancer depending on their age and then depending on the type of treatment they received. (Survival proportion per treatment)

bins = age group?

facet

```{r}

order = c('<30', '31-50', '50-60', '61-70', '>71')
patients |>
  ggplot(aes(x = factor(Age_group, levels = order),
             fill = factor(Sex))) +
  geom_bar(position = "dodge")+
  labs(title="Proportion of Cancer diagnosed in Men and Woman at different ages", 
       x = "Age group at Diagnosis (years)", fill = 'Gender')+
  scale_fill_discrete(label = c('Male', 'Female'))
  #facet_wrap(~ Suvival.Status.Clean)
```

Most cases of cancer Seem to be diagnosed in between the ages of 61 to 70, for both man and woman. In general there seems to be more cases of cancers in man.

```{r}
patients |> 
  filter(Age_group == "61-70") |> 
  ggplot(mapping = aes(x = Drug.Type,
                       fill = factor(Sex)))+
  geom_bar(position = "dodge")
```

```{r}
patients |>
  filter(Age_group == "61-70") |> 
  ggplot(mapping = aes(x = Drug.Type,
                       y = Survival_Months,
                       fill = factor(OS_status)))+
  geom_boxplot()+
  facet_wrap(~ Sex)+
  labs(title = 'Box Plot of the Drug success rate based on the proportion of patients still alive vs dead with the same drug', fill = 'Status', x = 'Drug Type against Cancer', y = 'Number of months survived')+
  scale_fill_discrete(label = c('Alive', "Desceased"))+
  theme()
#Might not be the best way to represent it becase, how many patients total per drug? 
```

How many months considered still alive?

outliers-\> drop?

```{r}
summ_age <- count(patients$Age_average)
patients |> 
  ggplot(aes(x = summ_age, y = Suvival.Status.Clean)) +
  geom_line(alpha = 0.4) 
```

```{r}

#Using the Kaplan Meier based survival function: 

KM_f <- survfit(Surv(Survival_Months, OS_status) ~1, data = patients)

#convert to a tibble

tibble_KM_f <- tibble(
  time = KM_f$time,
  survival = KM_f$surv)
print(tibble_KM_f)

ggplot(tibble_KM_f, 
       mapping = aes(x = time,
                     y = survival))+
  geom_step()+
  labs(title = 'Overall Survival rate of the patients')
#change y min to 0 bcs they are not ALL dead 
#x max needs to change too


```

```{r}

#Using the Kaplan Meier based survival function, declining it to the different sobservations that we can make
#survival rate based on the gender of the patients:


KM_f <- survfit(Surv(Survival_Months, OS_status) ~Sex, data = patients)

#convert to a tibble
#print(summary(KM_f))
names(KM_f)
print(KM_f)
tibble_KM_f <- tibble(
  time = KM_f$time,
  survival = KM_f$surv,
  strata = rep(names(KM_f$strata),KM_f$strata))
print(tibble_KM_f)
ggplot(tibble_KM_f,
       mapping = aes(x = time, 
                     y = survival, 
                     color = strata))+
  geom_step()+
  labs(title = 'Survival Curve of the patients depending on their gender', color = 'Gender')+
  scale_color_discrete(label = c('Female', 'Male'))
```

```{r}
KM_f <- survfit(Surv(Survival_Months, OS_status) ~Age_group, data = patients)

#convert to a tibble
#print(summary(KM_f))
names(KM_f)
print(KM_f)
tibble_KM_f <- tibble(
  time = KM_f$time,
  survival = KM_f$surv,
  strata = rep(names(KM_f$strata),KM_f$strata))
print(tibble_KM_f)
ggplot(tibble_KM_f,
       mapping = aes(x = time, 
                     y = survival, 
                     color = strata))+
  geom_step()+
  labs(title = 'Survival Curve of the patients depending on their Age at the dignostic', color = 'Age Group')+
  scale_color_discrete(label = order)
```

```{r}
KM_f <- survfit(Surv(Survival_Months, OS_status) ~Drug.Type, data = patients)

#convert to a tibble
#print(summary(KM_f))
names(KM_f)
print(KM_f)
tibble_KM_f <- tibble(
  time = KM_f$time,
  survival = KM_f$surv,
  strata = rep(names(KM_f$strata),KM_f$strata))
print(tibble_KM_f)
ggplot(tibble_KM_f,
       mapping = aes(x = time, 
                     y = survival, 
                     color = strata))+
  geom_step()+
  labs(title = 'Survival Curve of the patients depending on their Medicationr', color = 'Drug')+
  scale_color_discrete(label = c('CTLA4', 'PD-1/PDL-1', 'Combo'))
```

From the course website we try to make a linear regression model

```{r Logistic Regression Model}
my_glm_mdl <- glm(formula = OS_status ~ Survival_Months,
                  family = binomial(link = "logit"),
                  data = patients)
my_glm_mdl
```

```{r}

patients |>
  mutate(my_glm_model = pluck(my_glm_mdl, "fitted.values")) |>
  arrange(Survival_Months) |> 
  ggplot(aes(x = Survival_Months,
             y = OS_status)) +
  geom_point(alpha = 0.5,
             size = 3)+
  geom_line(aes(y = my_glm_model))+
  labs(title = 'Death rate of patients')

```

Death rate decreases over time

However, the problem with a GLM, is that it does not take into account the "censored" patients, some patients are alive after 4 months but there is no later update. The data does not follow the patient until the end yet GML assumes it does.

To get a survival curve we would need to use the Kaplan-Meier model.

## **Creating survival objects and curves**

The Kaplan-Meier method is the most common way to estimate survival times and probabilities. It is a non-parametric approach that results in a step function, where there is a step down each time an event occurs.

```{r}
patients |> 
  arrange(Survival_Months) |> 
  #Runs from 0 to 14 months
  total_patients <- count() |>
  filter(Survival_Months == 0) |> 
  filter(OS_status == 1) |> 
  dead_m0 <- count() |> 
  p_m0 <- (total_patients-dead_m0)/total_patients
  


  
```
